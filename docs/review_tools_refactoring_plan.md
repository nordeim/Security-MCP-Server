# Findings

- **Aggressive default flags reintroduced**. The proposal in [docs/tools_refactored.md](cci:7://file:///Home1/project/Security-MCP-2/docs/tools_refactored.md:0:0-0:0) injects defaults that already exist, producing duplicates (e.g., `-t` and `-w` appear twice in [GobusterTool](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/tools/gobuster_tool.py:19:0-600:9) and [MasscanTool](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/tools/masscan_tool.py:18:0-456:9)). It also adds privileged defaults to [HydraTool](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/tools/hydra_tool.py:17:0-469:24) even when the user provided them. This breaks the guarantee that optimizer defaults are only applied when the user omits them.
- **[_parse_and_validate_args()](cci:1://file:///Home1/project/Security-MCP-2/mcp_server/tools/nmap_tool.py:288:4-379:34) misused**. The plan wraps `super()._parse_args()` and converts its `ValueError` into [ToolOutput](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/base_tool.py:170:0-187:30), but it omits the current request’s target/correlation details and feeds the sanitized string back into `shlex.split()` immediately afterward. This churn adds no safety and risks double parsing.
- **Hydra target flow conflicts with base validation**. Current inputs use [ToolInput](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/base_tool.py:128:0-167:24)’s `target` field for host validation; the refactor requires `host:service` formats and rewrites missing information, conflicting with existing call sites and base validation rules.
- **`_EXTRA_ALLOWED_TOKENS` too broad**. Proposed values (e.g., `"-t"`, `"10"`, `"--timeout", "10s"`) copy defaults from the optimizer rather than enumerating tokens that actually pass the sanitizer. The base class already accepts `-`-prefixed tokens and numbers, so these sets do not resolve any real failures but force future defaults to be hard-coded.
- **Hydra replacements add brand-new behavior**. The replacement introduces defaults such as forced SSH service, synthetic credentials, and verbose flags, none of which exist today. This violates the plan’s “preserve all original functionality” principle.
- **Missing follow-up steps**. Neither document specifies unit/integration testing expectations after the refactor, nor do they note required documentation updates (e.g., flag behavior changes).

# Recommended Actions

- **Rebuild the plan** with concrete file-specific diffs. Emphasize targeted changes: add `_FLAGS_REQUIRE_VALUE` and `_EXTRA_ALLOWED_TOKENS` only where the base sanitizer still rejects known-good tokens, and avoid re-specifying optimizer defaults.
- **Do not replace existing validation** unless it demonstrably blocks valid usage. Instead, shim the base sanitizer to respect tool metadata, mirroring the changes already applied in [NmapTool](cci:2://file:///Home1/project/Security-MCP-2/mcp_server/tools/nmap_tool.py:18:0-547:9).
- **Retain current argument optimizers**. Keep [_optimize_mode_args()](cci:1://file:///Home1/project/Security-MCP-2/mcp_server/tools/gobuster_tool.py:514:4-559:24) (Gobuster) and [_apply_safety_limits()](cci:1://file:///Home1/project/Security-MCP-2/mcp_server/tools/masscan_tool.py:373:4-416:34) (Masscan) responsible for defaults; do not push defaults in [_parse_and_validate_args()](cci:1://file:///Home1/project/Security-MCP-2/mcp_server/tools/nmap_tool.py:288:4-379:34).
- **Hydra adjustments** should be incremental: add missing type hints, ensure [_secure_hydra_args()](cci:1://file:///Home1/project/Security-MCP-2/mcp_server/tools/hydra_tool.py:253:4-378:32) handles errors cleanly, and define `_FLAGS_REQUIRE_VALUE` to assist the base sanitizer—without introducing new defaults or target formats.
- **Document and test** every change. For each tool, plan unit tests that cover empty-extra-args, user-specified flags, and optimizer-only runs. Update tool READMEs or usage docs if behavior shifts (for example, if defaults were intentionally changed).
